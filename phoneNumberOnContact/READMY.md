# Телефон на странице контактов
Вы работаете в компании, присутствующей в нескольких городах РФ. На сайте компании есть страница с контактной информацией.
Маркетолог поставил задачу и уехал, к его приезду задача должна быть реализована.

На страницу контактов заходят люди из разных городов, нужно чтобы они видели телефон из своего города. По умолчанию, 
в HTML-страницы прописан телефон 8-800-DIGITS. Телефон размещен вверху и внизу страницы.

Вот и все что рассказал маркетолог прежде чем уехать.

## Решение
1. "Маркетолог поставил задачу и уехал, к приезду должна быть решена" - очень сильно расходится с моим опытом 
бизнес-процессов. Почему сроки решение задачи как то привязаны к перемещениям менеджера - тоже не ясно. Но может я чего
не понимаю или в таких шарашках не работал. Вообще задача крайне странная - кажется ее решать вообще **неправильно**.
2. Есть некий пул телефонов. Видимо они все 8-800? С точки зрения бизнеса крайне сомнительно разделение по городам, 
основываясь на номере телефона, намного проще включить в "скрипты" call-центра вопрос "В каком городе вы находитесь?"
3. Размещение контактных телефонов только на одной странице? Странный подход если компания торговая, возможно имеет смысл
отображать его в шапке, футере на всех страницах, добавлять форму "Оставьте свой номер и мы вам перезвоним".
4. Городов присутствия компании несколько, в России 1134 города. Кроме того есть еще пгт, деревни, неосвоенная тундра, 
заграница. Исходя из этого города присутствия нужно распределить по геополигонам или регионам, чтобы понимать, какой город
выбирать для конкретного пользователя.
5. _Как получить город из данных посетителя сайта?_ Определить по ip клиента. Есть SAAS сервисы (платные и условно-бесплатные),
есть локальные базы для определения (MaxMind, ip2location еtс). Точность определения - средняя, учитывая что есть vpn/мобильный интернет.
6. Как заменить 8-800-DIGITS на номер из "базы городов по ip"? Очень сильно зависит от того что за сайт.

### Варианты:

- Сайт на php? Выводится через единый скрипт, допустим index.php?
```php
<?php

$bufferOn = false;
if ($_SERVER['QUERY_STRING'] === 'Адрес страницы контактов'){
    ob_start();
    $bufferOn = true;
}


// Основной код сайта
if ($bufferOn){
    $out = ob_get_contents();
    $userIp = $_SERVER['REMOTE_ADDR'];// или $_SERVER['HTTP_X_FORWARDED_FOR'](последний адрес из цепочки) или HTTP_CLIENT_IP или HTTP_CF_CONNECTING_IP или HTTP_X_REAL_IP - зависит от размещения сайта.
    
    $phone = $geoMappingService->getPhoneByIp($userIp);
    $newOut = str_replace("8-800-DIGITS", $phone, $out);
    ob_end_clean();
    
    echo $newOut;
}

```

- Если сайт на контролируемом компанией сервере и он под управлением nginx: ngx_http_geoip_module + ngx_http_sub_module,
маппинг регионов сохраним в бд, сопоставление проведем на lua-nginx-module + кеш в редис
_Плюсы решения:_ относительно быстро и не зависит от того, на чем сайт написан, достаточно производительно, 
_Минусы:_ нужен доступ к nginx, возможность устанавливать/настраивать дополнительные модули. На каждый запрос
пользователя будет запрос к базе гео-координат. Можно избежать записывая в куку и при наличии восстанавливать значение из нее.

- Сайт на чистом html? Правим код, добавляя js-скрипт, который из внешнего сервиса по ip получит геоданные и замапит их 
на нужный телефон
_Плюсы решения: быстро, просто. Минимальное расширение функционала сайта
_Минусы:_ У внешнего сервиса лимиты на запросы, запросы к api соответствуют количеству запросов к сайту компании. Можно 
использовать куку для кеширования.